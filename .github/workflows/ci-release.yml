name: Build, Pack and Upload Release Asset

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build-and-publish:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Find Project and Publish Profile
        id: info
        shell: pwsh
        run: |
          # Find the .csproj
          $proj = (Get-ChildItem -Path . -Recurse -Filter *.csproj | Select-Object -First 1).FullName
          echo "proj=$proj" >> $env:GITHUB_OUTPUT
          
          # Find the first .pubxml in Properties/PublishProfiles
          $profile = (Get-ChildItem -Path . -Recurse -Filter *.pubxml | Select-Object -First 1).BaseName
          if (-not $profile) {
            Write-Error "No Publish Profile (.pubxml) found. Please create one in Visual Studio first."
            exit 1
          }
          echo "profile=$profile" >> $env:GITHUB_OUTPUT
          Write-Host "Using Project: $proj"
          Write-Host "Using Profile: $profile"

      - name: Restore
        run: dotnet restore "${{ steps.info.outputs.proj }}"

      - name: Publish using VS Profile
        run: |
          dotnet publish "${{ steps.info.outputs.proj }}" `
            -c Release `
            /p:PublishProfile="${{ steps.info.outputs.profile }}" `
            -o ./artifacts

      - name: Zip Executable
        id: package
        shell: pwsh
        run: |
          # Clean up any PDBs if they were included by the profile
          Get-ChildItem -Path ./artifacts -Filter *.pdb -Recurse | Remove-Item -Force -ErrorAction SilentlyContinue

          $exe = Get-ChildItem -Path ./artifacts -Filter *.exe -Recurse | Select-Object -First 1
          if (-not $exe) {
            Write-Error "No executable found in ./artifacts. Check your Publish Profile settings."
            exit 1
          }
          
          $zipName = "$($exe.BaseName).zip"
          $zipPath = Join-Path (Get-Item ./artifacts).FullName $zipName
          Compress-Archive -Path $exe.FullName -DestinationPath $zipPath -Force
          
          echo "zip_path=$zipPath" >> $env:GITHUB_OUTPUT

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.package.outputs.zip_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
